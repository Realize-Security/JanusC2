{% extends "base.html" %}

{% block content %}

<body class="sb-nav-fixed">
    <div id="layoutSidenav">
        {% include "dashboard/sidenav.html" %}
        <div id="layoutSidenav_content">
            <main>
                <div class="container-fluid px-4">
                    {% include "flash.html" %}
                    <h1 class="mt-4">Commands</h1>
                    <div class="form-group">
                        <label for="exampleFormControlTextarea1">Response Data</label>
                        <textarea class="form-control" id="response-form-output" placeholder="root" rows="3"
                            readonly></textarea>
                    </div>
                    {% include "dashboard/command_input.html" %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-comments me-1"></i>
                        </div>
                        <script type="text/javascript">

                            var base = 'http://127.0.0.1:5000'

                            function displayResponse(id) {
                                if (id == "") {
                                    return;
                                }
                                let data = fetchById(id).then(data => ({
                                    data: data
                                })).then(res => {
                                    document.getElementById("response-form-output").value = res.data.content;
                                });
                            }

                            function fetchById(id) {
                                return postData(base + '/api/agents/command/admin-message-by-id', { "id": id });
                            }

                            async function postData(url = '', data = {}) {
                                const response = await fetch(url, {
                                    method: 'POST',
                                    mode: 'cors',
                                    cache: 'no-cache',
                                    credentials: 'same-origin',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    redirect: 'follow',
                                    referrerPolicy: 'no-referrer',
                                    body: JSON.stringify(data)
                                });
                                return await response.json();
                            }

                            function sleep(ms) {
                                return new Promise(resolve => setTimeout(resolve, ms));
                            }

                        </script>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Command</th>
                                    <th>Response</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if commands %}
                                {% for command in commands %}
                                <tr>
                                    <td>
                                        <button type="button" class="btn btn-primary"
                                            onclick="displayResponse('{{command.id}}')">{{command.command}}</button>
                                    </td>
                                    {% if command.content %}
                                        {% set content = "Response Received" %}
                                    {% else %}
                                        {% set content = "None" %}
                                    {% endif %}
                                    <td id="{{command.id}}">
                                        {{content}}
                                    </td>
                                    <script type="text/javascript">
                                        async function checkCompletion() {
                                            if (document.getElementById('{{command.id}}').innerText !== "Response Received") {
                                                let noRes = true;
                                                while (noRes) {
                                                    let data = fetchById('{{command.id}}').then(data => ({
                                                        data: data
                                                    })).then(res => {
                                                        if (res.data.content) {
                                                            document.getElementById('{{command.id}}').innerHTML = "Response Received";
                                                            noRes = false;
                                                        }
                                                    });
                                                    await sleep(10000);
                                                }
                                            }

                                        }
                                        checkCompletion();
                                    </script>
                                </tr>

                                {% endfor %}
                                {% endif %}


                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
</body>

{% endblock %}